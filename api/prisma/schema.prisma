generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

enum VoucherInvoiceStatus {
  DRAFT
  CLOSED
}

enum VoucherMarketAllocationStatus {
  DEFAULT       // 541 padrão
  FALTA         // 0
  PROPORCIONAL  // valor editável
  EXCLUIDO      // 0 e não participa do vale mercado
}

model Employee {
  id              Int       @id @default(autoincrement())
  name            String
  matricula       String    @unique
  costCenter      String
  branch          String
  admissionDate   DateTime  @db.Date
  terminationDate DateTime? @db.Date

  voucherMarketExcluded Boolean @default(false)
  voucherMarketAllocations VoucherMarketAllocation[]

  voucherMealAllocations   VoucherMealAllocation[]
  voucherMealExcluded Boolean @default(false)

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([branch])
  @@index([costCenter])
  @@index([terminationDate])
  @@index([voucherMarketExcluded])
  @@index([voucherMealExcluded])
}

model VoucherMealInvoice {
  id                  Int                 @id @default(autoincrement())
  competence           DateTime            @db.Date // 1º dia do mês: YYYY-MM-01

  // A empresa recebe DUAS notas para o mês:
  // - 2ª quinzena do mês (competência)
  // - 1ª quinzena do mês seguinte
  invoiceSecondHalf    Decimal             @db.Decimal(12, 2)
  invoiceFirstHalfNext Decimal             @db.Decimal(12, 2)

  status               VoucherInvoiceStatus @default(DRAFT)
  closedAt             DateTime?

  allocations          VoucherMealAllocation[]

  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  @@unique([competence])
}

model VoucherMealAllocation {
  id         Int      @id @default(autoincrement())
  invoiceId  Int
  employeeId Int

  // Valor lançado (20%) = desconto do funcionário
  employee20 Decimal  @db.Decimal(12, 2)
  // 80% = empresa
  company80  Decimal  @db.Decimal(12, 2)
  // 100% = total
  total100   Decimal  @db.Decimal(12, 2)

  invoice    VoucherMealInvoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  employee   Employee           @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([invoiceId, employeeId])
  @@index([employeeId])
}

model VoucherMarketInvoice {
  id            Int                 @id @default(autoincrement())
  competence    DateTime            @db.Date // 1º dia do mês: YYYY-MM-01
  invoiceNumber String
  invoiceValue  Decimal             @db.Decimal(10, 2)

  status        VoucherInvoiceStatus @default(DRAFT)
  closedAt      DateTime?

  allocations   VoucherMarketAllocation[]

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([competence])
  @@index([invoiceNumber])
}

model VoucherMarketAllocation {
  id         Int      @id @default(autoincrement())
  invoiceId  Int
  employeeId Int

  amount     Decimal  @db.Decimal(10, 2)
  status     VoucherMarketAllocationStatus @default(DEFAULT)
  note       String?

  invoice    VoucherMarketInvoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  employee   Employee             @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([invoiceId, employeeId])
  @@index([employeeId])
}
